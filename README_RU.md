## Синхрофазотрон golang 0.0.1

### Проблематика.

При разработке кода множественным командами в одной предметной области происходит нелинейное развитие в различных его
частях.  
Данная расфазировка между различными частями кода приводит к проблемам совместимости что является основной болью
технической поддержки, баг-инжиниринга и команды DevOps.

### Введение.

В основном системы хранения и версионирования кода работают основывая под капотом на git.  
Данный туллинг под капотом также использует git и предоставляет автоматизацию создания и развития монорепозитория.

### Компоненты.

1. Инициализация.
2. Синхронизация

### Места хранения.

1. Конфигурационные файлы ./scripts/config
2. Хуки ./scripts/hooks
3. Туллинг ./scripts/tools

### Инициализация.

#### Конфигурация предоставлена в ./scripts/config/init.sh.json

```json
{
  "git": {
    "remote": "git@github.com:mvp-simple/auto-merge-result.git"
  },
  "repositories": {
    "dauni-ml": "https://github.com/rinatusmanov/dauni-ml.git",
    "gg/dauni-ml": "https://github.com/rinatusmanov/dauni-ml.git",
    "jsonrpc20": "https://github.com/rinatusmanov/evgeniya.git"
  }
}
```

| Ключ         | Пояснение                                                                       |
|--------------|---------------------------------------------------------------------------------|
| git.remote   | репозиторий куда будет складываться результат                                   |
| repositories | репозитории источники, при этом в ключах можно указать какую угодно вложенность |

#### Жизненный цикл инициализации.

| # | Тип    |                  | Пояснение                      |
|---|--------|------------------|--------------------------------|
| 1 | хук    | _download_before |                                |
| 2 | логика |                  | загрузка исходных репозиториев |
| 3 | хук    | _download_after_ |                                |

Хуки ищутся в папке /scripts/hooks/init.sh/

#### Команда запуска.

```bash
./scripts/init.sh
```

### Синхронизация.

#### Конфигурация предоставлена в ./scripts/config/sync.sh.json

```json
{
  "repositories": [
    "dauni-ml",
    "gg/dauni-ml",
    "jsonrpc20"
  ]
}
```

| Ключ         | Пояснение                                                                                                               |
|--------------|-------------------------------------------------------------------------------------------------------------------------|
| repositories | репозитории источники, с которых будут загружаться обновления, при этом в ключах можно указать какую угодно вложенность |

#### Жизненный цикл синхронизации.

| # | Тип    |                       | Пояснение                                                           |
|---|--------|-----------------------|---------------------------------------------------------------------|
| 1 | хук    | _clean_pull_before    | запускается до очистки всех изменений в наблюдаемых репозиториях    |
| 2 | логика |                       | очистка всех изменений в наблюдаемых репозиториях                   |
| 3 | хук    | _clean_pull_after     | запускается после очистки всех изменений в наблюдаемых репозиториях |
| 4 | хук    | _vendor_folder_before | запускается до запуска вложенного компонента make-vendor-folder     |
| 5 | логика |                       | запуск вложенного компонента make-vendor-folder                     |
| 6 | хук    | _vendor_folder_after  | запускается после запуска вложенного компонента make-vendor-folder  |
| 7 | хук    | _rush_result_before   | запускается до отправки готового результата                         |
| 8 | логика |                       | отправки готового результата                                        |
| 9 | хук    | _rush_result_after    | запускается после отправки готового результата                      |

Хуки ищутся в папке /scripts/hooks/sync.sh/

#### Команда запуска.

```bash
./scripts/sync.sh
```

### Компонент собиратель зависимостей.

#### Конфигурация предоставлена в ./scripts/config/make-vendor-folder.sh.json

```json
{
  "source_module": "github.com/rinatusmanov",
  "source_go_version": "1.18"
}
```

| Ключ              | Пояснение                                                             |
|-------------------|-----------------------------------------------------------------------|
| source_module     | название результативного пакета которое будет использоваться в go.mod |
| source_go_version | версия golang которая будет использоваться в go.mod                   |

#### Жизненный цикл собирателя зависимостей.

| #  | Тип    |                        | Пояснение                                                              |
|----|--------|------------------------|------------------------------------------------------------------------|
| 1  | хук    | _gomod_before_prepare  | запускается до сканирования go.mod во всех директориях папки result    |
| 2  | логика |                        | сканированиe go.mod во всех директориях папки result                   |
| 3  | хук    | _gomod_after_prepared  | запускается после сканирования go.mod во всех директориях папки result |
| 4  | хук    | _gosum_before_prepare  | запускается до сканирования go.sum во всех директориях папки result    |
| 5  | логика |                        | сканированиe go.sum во всех директориях папки result                   |
| 6  | хук    | _gosum_after_prepared  | запускается после сканирования go.sum во всех директориях папки result |
| 7  | хук    | _vendor_before_replace | запускается до перемещение папок vendor вложенных в папку result       |
| 8  | логика |                        | перемещение папок vendor вложенных в папку result                      |
| 9  | хук    | _vendor_after_replace_ | запускается после перемещение папок vendor вложенных в папку result    |
| 10 | хук    | _gomod_before_rename_  | запускается до переименования go.mod в вложенных директориях result    |
| 11 | логика |                        | переименованиe файлов go.mod в вложенных директориях result            |
| 12 | хук    | _gomod_after_renamed_  | запускается после переименования go.mod в вложенных директориях result |
| 13 | хук    | _gosum_before_rename_  | запускается до переименования go.sum в вложенных директориях result    |
| 14 | логика |                        | переименование файлов go.sum в вложенных директориях result            |
| 15 | хук    | _gosum_after_renamed_  | запускается после переименования go.sum в вложенных директориях result |
| 16 | хук    | _vendor_before_create  | запускается до создания директории vendor                              |
| 17 | логика |                        | создание директории vendor                                             |
| 18 | хук    | _vendor_after_create_  | запускается после создания директории vendor                           |

Хуки ищутся в папке /scripts/hooks/make-vendor-folder.sh/

#### Команда запуска.

```bash
./scripts/make-vendor-folder.sh
```

### Хуки.

#### Места хранения

| # | компонент                  | место хранения                        |
|---|----------------------------|---------------------------------------|
| 1 | инициализация              | /scripts/hooks/init.sh/               |
| 2 | синхронизация              | /scripts/hooks/sync.sh/               |
| 3 | создание vendor директории | /scripts/hooks/make-vendor-folder.sh/ |

#### Формирование наименования хуков

Туллинг ищет в местах хранения запускаемые (он сам выдает им права за запуск) файлы.  
Это могут быть shell скрипты, бинарные исполняемые файлы и т.д.  
Если найдено несколько хуков то они исполняются в алфавитном порядке.

Название файлов хуков должно начинаться с названия хука

К примеру у синхронизации есть хук _rush_result_before соответственно в папке /scripts/hooks/sync.sh/ при наступлении
вызове события _rush_result_before будут искаться все файлы начинающиеся с _rush_result_before

Пример хука

```bash
#!/bin/bash
SCRIPT_DIR=$(cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd)
echo "Hello i am a hook _rush_result_before"
```